# План работ: единый кабинет мастера для Telegram + MAX

Статус: подготовлено к реализации, **не запускать до отдельной отмашки**.
Дата фиксации плана: 2026-02-17.

## Цель

Обеспечить работу с Telegram и MAX одновременно при едином кабинете мастера:
- мастер работает в одном интерфейсе;
- сообщения клиентам отправляются только в тот канал, где клиент написал;
- история диалогов и процессы единые.

## План работ

### 1. Сбор требований и границ
- Зафиксировать сценарии: вход в TG/MAX, ответ только в исходный канал, единый кабинет.
- Определить SLA, роли, шаблоны сообщений, правила fallback.
- Результат: согласованный `Scope` и `Acceptance Criteria`.

### 2. Техдизайн омниканальности
- Описать архитектуру: `channel adapters` + `unified inbox`.
- Спроектировать контракты: `InboundMessage`, `OutboundMessage`, `DeliveryStatus`.
- Результат: ADR/дизайн-документ.

### 3. Модель данных и миграции
- Добавить сущности каналов, внешних идентификаторов, диалогов, сообщений, статусов доставки.
- Настроить индексы, идемпотентность и правила связывания клиента между каналами.
- Результат: SQL-миграции и актуальная схема БД.

### 4. Интеграция Telegram
- Настроить webhook, валидацию, парсинг входящих апдейтов, отправку.
- Добавить дедупликацию, retry/backoff, логирование ошибок API.
- Результат: рабочий TG-адаптер.

### 5. Интеграция MAX
- Настроить webhook-подписку (`/subscriptions`), приём событий, отправку сообщений.
- Добавить обработку лимитов/ошибок, идемпотентность, ретраи.
- Результат: рабочий MAX-адаптер.

### 6. Единый кабинет мастера
- Реализовать общий inbox с фильтрами по каналам.
- Ввести жёсткое правило: ответ уходит только через канал текущего диалога.
- Результат: единый UI/Backend-поток “один кабинет, два канала”.

### 7. Надёжность и наблюдаемость
- Добавить очередь исходящих, DLQ, метрики, алерты, аудит.
- Настроить дашборды: delivery rate, webhook errors, retry queue.
- Результат: эксплуатационная готовность.

### 8. Тестирование и UAT
- Подготовить интеграционные и e2e-тесты для TG и MAX.
- Покрыть кейсы: дубли событий, недоступность API, 429/5xx.
- Результат: протокол UAT и чеклист релиза.

### 9. Запуск и стабилизация
- Провести поэтапный rollout: пилот -> частичный запуск -> 100%.
- Вести мониторинг 1-2 недели и закрывать инциденты.
- Результат: production-ready режим.

### 10. Документация и регламенты
- Подготовить инструкции для саппорта и мастеров, runbook инцидентов.
- Зафиксировать регламент подключения новых каналов.
- Результат: комплект эксплуатационной документации.

## Критерии готовности

- Единый кабинет показывает диалоги из TG и MAX.
- Ответ из диалога отправляется только в его канал.
- Нет потерь сообщений при временных сбоях API (за счёт retry и очередей).
- Канальные интеграции наблюдаемы через метрики/алерты.

## Условие старта

Реализация начинается только после явной команды от владельца задачи.
