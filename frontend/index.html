<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2f9f68">
  <meta name="description" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–∞—Å—Ç–µ—Ä–∞: –∑–∞–ø–∏—Å–∏, –∫–ª–∏–µ–Ω—Ç—ã, –∑–∞–¥–∞—á–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–∞—Å—Ç–µ—Ä–∞</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="networkBanner" class="network-banner" style="display: none;">
    <span id="networkBannerText"></span>
    <button id="networkRetryBtn" class="btn-small">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div class="container" id="authScreen">
    <header>
      <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–∞—Å—Ç–µ—Ä–∞</h1>
      <p id="authSubtitle">–í—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram Mini App</p>
    </header>

    <section class="auth-section">
      <div id="telegramOnlyNotice" class="auth-error">
        –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram Mini App. –í–µ–±-–≤—Ö–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω.
      </div>
      <p class="auth-hint">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –†–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≤–∞—à–µ–º—É Telegram ID.
      </p>
      <button id="tgAuthRetryBtn" type="button" class="btn-primary btn-small">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Ö–æ–¥</button>
    </section>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
  <div id="appScreen" style="display: none;">
    <!-- –í–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞ -->
    <div class="app-header">
      <h1 class="app-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–∞—Å—Ç–µ—Ä–∞</h1>
      <div class="app-header-right">
        <span id="currentUser"></span>
        <button class="btn-small btn-logout" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —ç–∫—Ä–∞–Ω–æ–≤ -->
    <div class="app-content">
      <!-- –≠–∫—Ä–∞–Ω: Dashboard -->
      <div class="screen" id="screen-dashboard">
        <section class="dashboard-section">
          <h2>–°–≤–æ–¥–∫–∞</h2>

          <form id="dashboardQuickForm" class="dashboard-quick-form">
            <input
              type="text"
              id="dashboardQuickTitle"
              placeholder="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è..."
              required
            >
            <button type="submit" class="btn-primary btn-small">–î–æ–±–∞–≤–∏—Ç—å</button>
          </form>

          <div class="dashboard-cards">
            <article class="dashboard-card">
              <h3>–°–µ–≥–æ–¥–Ω—è</h3>
              <div class="dashboard-count" id="dashTodayCount">0</div>
              <div class="dashboard-list" id="dashTodayList"></div>
            </article>
            <article class="dashboard-card">
              <h3>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</h3>
              <div class="dashboard-count" id="dashOverdueCount">0</div>
              <div class="dashboard-list" id="dashOverdueList"></div>
            </article>
            <article class="dashboard-card">
              <h3>–ë–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è</h3>
              <div class="dashboard-count" id="dashUpcomingCount">0</div>
              <div class="dashboard-list" id="dashUpcomingList"></div>
            </article>
          </div>

          <div class="dashboard-stats">
            –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <strong id="dashDoneWeek">0</strong>
          </div>

          <div id="dashboardError" class="auth-error"></div>
        </section>
      </div>

      <!-- –≠–∫—Ä–∞–Ω: –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
      <div class="screen" id="screen-calendar" style="display: none;">
        <section class="calendar-section">
          <div class="calendar-view-switcher" id="calendarViewSwitcher">
            <button class="calendar-view-btn active" data-view="month" onclick="setCalendarView('month')">–ú–µ—Å—è—Ü</button>
            <button class="calendar-view-btn" data-view="week" onclick="setCalendarView('week')">–ù–µ–¥–µ–ª—è</button>
            <button class="calendar-view-btn" data-view="day" onclick="setCalendarView('day')">–î–µ–Ω—å</button>
          </div>
          <div class="calendar-header">
            <button class="btn-small btn-nav" onclick="prevMonth()">&laquo;</button>
            <div class="calendar-title-group">
              <h2 id="calendarTitle"></h2>
              <button class="btn-today" onclick="goToday()">–°–µ–≥–æ–¥–Ω—è</button>
            </div>
            <button class="btn-small btn-nav" onclick="nextMonth()">&raquo;</button>
          </div>
          <div class="calendar-weekdays" id="calendarWeekdays">
            <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div class="weekend">–°–±</div><div class="weekend">–í—Å</div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="calendar-week-view" id="calendarWeekView" style="display: none;"></div>
          <div class="calendar-day-view" id="calendarDayView" style="display: none;"></div>
        </section>
      </div>

      <!-- –≠–∫—Ä–∞–Ω: –ó–∞–¥–∞—á–∏ -->
      <div class="screen" id="screen-tasks" style="display: none;">
        <section class="add-task">
          <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h2>
          <form id="taskForm">
            <div class="form-group">
              <label for="taskTitle">–ó–∞–¥–∞—á–∞:</label>
              <input type="text" id="taskTitle" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" required>
            </div>
            <div class="form-group">
              <label for="taskDate">–î–∞—Ç–∞:</label>
              <input type="date" id="taskDate" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="taskPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                <select id="taskPriority">
                  <option value="low">–ù–∏–∑–∫–∏–π</option>
                  <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                  <option value="urgent">–°—Ä–æ—á–Ω—ã–π</option>
                </select>
              </div>
              <div class="form-group">
                <label for="taskStatus">–°—Ç–∞—Ç—É—Å:</label>
                <select id="taskStatus">
                  <option value="backlog">–ë—ç–∫–ª–æ–≥</option>
                  <option value="planned" selected>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
                  <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
          </form>
        </section>

        <section class="tasks-list">
          <div class="tasks-filters" id="tasksFilters">
            <select id="tasksFilterStatus">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="backlog">–ë—ç–∫–ª–æ–≥</option>
              <option value="planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
              <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="done">–ì–æ—Ç–æ–≤–æ</option>
              <option value="canceled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
              <option value="archived">–ê—Ä—Ö–∏–≤</option>
            </select>
            <select id="tasksFilterAssignee">
              <option value="">–õ—é–±–æ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</option>
            </select>
            <select id="tasksFilterTag">
              <option value="">–õ—é–±–æ–π —Ç–µ–≥</option>
            </select>
            <select id="tasksFilterList">
              <option value="">–õ—é–±–æ–π —Å–ø–∏—Å–æ–∫</option>
            </select>
            <select id="tasksSortBy">
              <option value="due_at">–°—Ä–æ–∫</option>
              <option value="date">–î–∞—Ç–∞</option>
              <option value="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
              <option value="status">–°—Ç–∞—Ç—É—Å</option>
              <option value="title">–ù–∞–∑–≤–∞–Ω–∏–µ</option>
            </select>
            <select id="tasksSortOrder">
              <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
              <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            </select>
            <button class="btn-small" id="tasksApplyFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>

          <div class="tasks-bulk-actions" id="tasksBulkActions">
            <span id="tasksSelectedCount">–í—ã–±—Ä–∞–Ω–æ: 0</span>
            <button class="btn-small" id="bulkSetPlanned">–í –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</button>
            <button class="btn-small" id="bulkSetDone">–í –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
            <button class="btn-small btn-delete" id="bulkDelete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>

          <div class="tasks-tabs" id="tasksTabs" style="display: none;">
            <button class="tasks-tab active" onclick="switchTasksView('my', this)">–ú–æ–∏ –∑–∞–¥–∞—á–∏</button>
            <button class="tasks-tab" onclick="switchTasksView('clients', this)">–ó–∞–¥–∞—á–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</button>
          </div>
          <h2 id="tasksTitle">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
          <div id="tasksContainer">
            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</p>
          </div>
          <div class="tasks-pagination" id="tasksPagination">
            <button class="btn-small" id="tasksPrevPage">–ù–∞–∑–∞–¥</button>
            <span id="tasksPageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 / 1</span>
            <button class="btn-small" id="tasksNextPage">–í–ø–µ—Ä–µ–¥</button>
          </div>
        </section>
      </div>

      <!-- –≠–∫—Ä–∞–Ω: –ö–ª–∏–µ–Ω—Ç—ã -->
      <div class="screen" id="screen-clients" style="display: none;">
        <section class="clients-section" id="clientsSection">
          <div class="clients-header">
            <h2>–ö–ª–∏–µ–Ω—Ç—ã</h2>
            <p class="clients-hint">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–≥–¥–∞-–ª–∏–±–æ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –∫ –º–∞—Å—Ç–µ—Ä—É</p>
          </div>
          <div id="clientsList" class="clients-list">
            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
          </div>
          <div id="clientsEmpty" class="no-tasks" style="display:none;">
            –ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∑–∞–ø–∏—Å—è–º–∏
          </div>
          <div id="clientBookingsSection" class="client-bookings-section" style="display:none;">
            <h3 id="clientBookingsTitle">–ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <div id="clientBookingsList" class="bookings-history-list"></div>
            <div id="clientBookingsEmpty" class="no-tasks" style="display:none;">
              –£ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π
            </div>
          </div>
          <div id="clientsError" class="auth-error"></div>
        </section>
      </div>

      <!-- –≠–∫—Ä–∞–Ω: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∞—É–¥–∏—Ç –ª–æ–≥) -->
      <div class="screen" id="screen-activity" style="display: none;">
        <section class="activity-section">
          <h2>–õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
          <div id="activityContainer">
            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
          </div>
          <div id="activityLoadMore" style="display: none;">
            <button class="btn-primary btn-small" onclick="loadMoreActivity()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>
          </div>
        </section>
      </div>

      <!-- –≠–∫—Ä–∞–Ω: –ö–∞–Ω–±–∞–Ω -->
      <div class="screen" id="screen-kanban" style="display: none;">
        <section class="kanban-section">
          <h2>–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞</h2>
          <div id="kanbanBoard">
            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</p>
          </div>
        </section>
      </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="bottom-nav" id="bottomNav">
      <a href="#/dashboard" class="nav-item active" data-route="dashboard">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">–°–≤–æ–¥–∫–∞</span>
      </a>
      <a href="#/calendar" class="nav-item" data-route="calendar">
        <span class="nav-icon">üìÖ</span>
        <span class="nav-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
      </a>
      <a href="#/tasks" class="nav-item" data-route="tasks">
        <span class="nav-icon">üìã</span>
        <span class="nav-label">–ó–∞–¥–∞—á–∏</span>
      </a>
      <a href="#/kanban" class="nav-item" data-route="kanban">
        <span class="nav-icon">üß©</span>
        <span class="nav-label">–ö–∞–Ω–±–∞–Ω</span>
      </a>
      <a href="#/clients" class="nav-item" data-route="clients">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">–ö–ª–∏–µ–Ω—Ç—ã</span>
      </a>
      <a href="#/activity" class="nav-item" data-route="activity">
        <span class="nav-icon">üîî</span>
        <span class="nav-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
      </a>
    </nav>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è -->
  <div class="modal-overlay" id="dayModal" style="display: none;" onclick="closeDayModal(event)">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalDate"></h2>
        <button class="btn-small btn-nav" onclick="closeDayModal()">&times;</button>
      </div>
      <div id="modalTasks"></div>
      <div class="modal-add">
        <input type="text" id="modalTaskTitle" placeholder="–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏...">
        <button class="btn-primary btn-small" onclick="addTaskFromModal()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ -->
  <div class="modal-overlay task-detail-overlay" id="taskDetailModal" style="display: none;" onclick="closeTaskDetailModal(event)">
    <div class="modal task-detail-modal">
      <div class="modal-header">
        <h2 id="taskDetailTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏</h2>
        <button class="btn-small btn-nav" onclick="closeTaskDetailModal()">&times;</button>
      </div>
      <div id="taskDetailBody">
        <div class="task-detail-grid">
          <section class="task-detail-section">
            <h3>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</h3>
            <div id="taskDetailMeta"></div>
          </section>
          <section class="task-detail-section">
            <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
            <textarea id="taskDetailDescription" rows="5" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è markdown)"></textarea>
            <div class="detail-actions">
              <button class="btn-small" onclick="saveTaskDetailDescription()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
            </div>
            <div class="task-detail-markdown" id="taskDetailDescriptionPreview"></div>
          </section>
          <section class="task-detail-section">
            <h3>–¢–µ–≥–∏</h3>
            <div class="detail-inline">
              <select id="taskDetailTagSelect"></select>
              <button class="btn-small" onclick="addTagToTaskDetail()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
            </div>
            <div id="taskDetailTags"></div>
          </section>
          <section class="task-detail-section">
            <h3>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</h3>
            <div class="detail-inline">
              <select id="taskDetailAssignSelect"></select>
              <select id="taskDetailAssignRole">
                <option value="assignee">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</option>
                <option value="watcher">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
              </select>
              <button class="btn-small" onclick="assignTaskDetailUser()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
            </div>
            <div id="taskDetailAssignees"></div>
          </section>
          <section class="task-detail-section">
            <h3>–ß–µ–∫-–ª–∏—Å—Ç</h3>
            <div class="detail-inline">
              <input id="taskDetailChecklistInput" type="text" placeholder="–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞">
              <button class="btn-small" onclick="addTaskDetailChecklistItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div id="taskDetailChecklist"></div>
          </section>
          <section class="task-detail-section">
            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div class="detail-inline">
              <input id="taskDetailCommentInput" type="text" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
              <button class="btn-small" onclick="addTaskDetailComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <div id="taskDetailComments"></div>
          </section>
          <section class="task-detail-section">
            <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
            <div id="taskDetailHistory"></div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script src="router.js"></script>
  <script src="calendar-views.js"></script>
  <script src="kanban-utils.js"></script>
  <script src="task-detail-utils.js"></script>
  <script src="polish-utils.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="telegram-miniapp.js"></script>
  <script src="app.js"></script>
</body>
</html>
