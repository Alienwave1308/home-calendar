name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Деплоим только если CI прошёл успешно
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - name: Deploy to VPS
      env:
        SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        HOST: ${{ secrets.DEPLOY_HOST }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $HOST >> ~/.ssh/known_hosts 2>/dev/null

        ssh -i ~/.ssh/deploy_key root@$HOST << 'ENDSSH'
          cd ~/home-calendar
          git pull origin main
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          echo "Deploy complete: $(date)"
        ENDSSH
